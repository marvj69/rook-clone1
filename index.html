<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rook - Game Scoring Screen</title>
  
  <!-- Set the theme color to white (will be updated dynamically based on theme) -->
  <meta name="theme-color" content="#ffffff">
  
  <!-- iOS specific status bar style -->
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <!-- 
    If you open from file://, manifest.json may throw CORS errors.
    For local dev, run a local server, e.g. `npx http-server .`
  -->
  <!-- <link rel="manifest" href="manifest.json"> -->
  
  <!-- Fallback icon -->
  <link rel="icon" href="icons/icon-192x192.png">

  <!-- 1) Load Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- 2) Configure Tailwind for class-based dark mode -->
  <script>
    tailwind.config = {
      darkMode: 'class', 
    }
  </script>
  
  <!-- Custom Styles -->
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
      animation: fadeIn 0.5s ease-out;
    }

    /* CSS Transitions for Slide Down and Slide Up */
    .score-input-container {
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transition: max-height 0.5s ease, opacity 0.5s ease;
    }
    .score-input-container.show {
      max-height: 1000px; /* Sufficiently large to accommodate content */
      opacity: 1;
    }

    /* Ensuring focus outlines are visible */
    .focus-outline:focus {
      outline: 2px dashed #3182ce;
      outline-offset: 2px;
    }

    /* Hide scrollbars for any .no-scrollbar containers */
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .no-scrollbar {
      -ms-overflow-style: none;  
      scrollbar-width: none;  
    }
    
    /* Save Indicator */
    #saveIndicator {
      position: fixed;
      bottom: 1rem; 
      right: 1rem;
      background-color: rgba(16, 185, 129, 0.7); 
      color: white;
      padding: 0.5rem 1rem; 
      border-radius: 0.375rem; 
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      opacity: 0;
      transition: opacity 0.3s ease-in-out; 
      pointer-events: none;
      z-index: 1000;
      font-size: 0.875rem; 
    }
    #saveIndicator.show {
      opacity: 1;
    }

    /* Hamburger Menu */
    .hamburger-menu {
      display: flex;
      flex-direction: column;
      cursor: pointer;
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1000;
      transition: opacity 0.3s ease; 
    }
    nav.show ~ .hamburger-menu {
      opacity: 0;
      pointer-events: none; 
    }
    .bar {
      width: 30px;
      height: 4px;
      background-color: #333;
      margin: 5px 0;
      transition: background-color 0.3s;
    }
    html.dark .bar {
      background-color: #fff;
    }

    /* Slide-out nav */
    nav {
      position: fixed;
      top: 0;
      left: -300px; /* Start off-screen */
      width: 250px; 
      height: 100%;
      background-color: white; 
      z-index: 999;
      transition: left 0.3s ease;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1); 
    }
    nav.show {
      left: 0; 
    }
    html.dark nav {
      background-color: #2d3748; /* Dark mode for nav */
    }

    nav ul {
      list-style-type: none;
      padding: 0;
      margin: 0;
      margin-top: 60px; /* Space for the close button */
    }
    nav ul li {
      margin: 0; 
      border-bottom: 1px solid #e0e0e0; 
    }
    nav ul li:last-child {
      border-bottom: none; 
    }
    nav ul li a, nav ul li button {
      color: #333; 
      text-decoration: none;
      font-size: 20px;
      padding: 15px 20px; 
      display: block;
      transition: background-color 0.3s ease; 
      width: 100%;
      text-align: left;
      background: none;
      border: none;
      cursor: pointer;
      font-family: inherit;
    }
    nav ul li a:hover, nav ul li button:hover {
      background-color: #f5f5f5; 
    }
    html.dark nav ul li a, html.dark nav ul li button {
      color: #fff;
    }
    html.dark nav ul li a:hover, html.dark nav ul li button:hover {
      background-color: #4a5568;
    }

    /* Nav close button */
    .close-menu {
      position: absolute;
      top: 20px;
      right: 20px;
      color: #333; 
      font-size: 30px;
      cursor: pointer;
    }
    html.dark .close-menu {
      color: #fff; 
    }
  </style>
</head>

<body class="bg-white text-gray-800 min-h-screen transition-colors duration-300 dark:bg-gray-900 dark:text-gray-100">
  <!-- Hamburger Menu -->
  <div class="hamburger-menu" onclick="toggleMenu(event)" aria-label="Open Menu" role="button" tabindex="0">
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
  </div>

  <!-- Slide-Out Nav -->
  <nav id="menu">
    <div class="close-menu" onclick="toggleMenu(event)" aria-label="Close Menu" role="button" tabindex="0">×</div>
    <ul>
      <li><a href="#" onclick="openSavedGamesModal(); toggleMenu(event)">View Saved Games</a></li>
      <li><a href="#" onclick="handleNewGame(); toggleMenu(event)">New Game</a></li>
      <li><a href="#" onclick="handleFreezerGame(); toggleMenu(event)">Freeze Game</a></li>
      <li>
        <button id="darkModeToggle" onclick="toggleDarkMode(event)" class="flex items-center focus:outline-none">
          <span id="darkModeIcon"></span>
          <span id="darkModeLabel" class="ml-2">Dark Mode</span>
        </button>
      </li>
    </ul>
  </nav>

  <!-- Version Indicator -->
  <div class="absolute top-0 right-0 m-4 p-2 text-gray-800 font-medium text-xs bg-white bg-opacity-70 rounded-full shadow px-3 py-1 dark:bg-gray-800 dark:text-gray-100">
    <p>Version 1.1</p>
  </div>
  
  <div id="app" class="max-w-4xl mx-auto p-4 sm:p-6 space-y-6"></div>

  <!-- Save Indicator -->
  <div id="saveIndicator" class="hidden">
    Saved
  </div>

  <!-- Saved Games Modal -->
  <div
    id="savedGamesModal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4"
    role="dialog"
    aria-modal="true"
    aria-labelledby="savedGamesTitle"
  >
    <div class="bg-white w-full max-w-4xl rounded-lg shadow-lg overflow-y-auto max-h-full dark:bg-gray-800">
      <div class="flex justify-between items-center p-5 border-b border-gray-200 dark:border-gray-700">
        <h3 id="savedGamesTitle" class="text-2xl font-semibold text-gray-800 dark:text-gray-100">Saved Games</h3>
        <button 
          id="closeSavedGamesModalBtn" 
          class="text-gray-700 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 
                 dark:text-gray-300 dark:hover:text-gray-100" 
          aria-label="Close Saved Games Modal">
          <!-- Close Icon -->
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
               viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round"
                  d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="p-5 space-y-6">
        <!-- Completed Games -->
        <div class="rounded-lg shadow-sm p-4 bg-gray-50 dark:bg-gray-700">
          <h4 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-100">Completed Games</h4>
          <div id="savedGamesList" class="space-y-4"></div>
        </div>
        <!-- Freezer Games -->
        <div class="rounded-lg shadow-sm p-4 bg-gray-50 dark:bg-gray-700">
          <h4 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-100">Freezer Games</h4>
          <div id="freezerGamesList" class="space-y-4"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    'use strict';

    /********************************************************
     * Icons (inline SVG)
     ********************************************************/
    const Icons = {
      AlertCircle: `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
             viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <circle cx="12" cy="12" r="10" />
          <path d="M12 8v4m0 4h.01" />
        </svg>
      `,
      Undo: `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none"
             viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path d="M3 7v6h6M21 17a9 9 0 0 0-9-9c-2.5 0-4.75.9-6.5 2.4L3 11" />
        </svg>
      `,
      Trash: `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
             viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round"
                d="M6 18L18 6M6 6l12 12" />
        </svg>
      `,
      Load: `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none"
             viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 11H6a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2v-6a8.001 8.001 0 0115.356-2z" />
        </svg>
      `,
      Sun: `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
             viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round"
                d="M12 3v1m0 16v1m8.66-8.66h-1M4.34 12.66h-1m15.364 4.95l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M12 8a4 4 0 100 8 4 4 0 000-8z" />
        </svg>
      `,
      Moon: `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
             viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round"
                d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" />
        </svg>
      `
    };

    /********************************************************
     * Constants, State, and ephemeral variables
     ********************************************************/
    const presetBids = [120, 125, 130, 135, 140, 'other'];
    const DEFAULT_STATE = {
      rounds: [],
      biddingTeam: '',
      bidAmount: '',
      customBidValue: '',
      showCustomBid: false,
      enterBidderPoints: false,
      error: '',
      gameOver: false,
      winner: null,
      savedScoreInputStates: {
        us: null,
        Dem: null
      },
      lastBidAmount: null,
      lastBidTeam: null
    };
    let state = { ...DEFAULT_STATE };

    // ephemeral
    let ephemeralCustomBid = '';
    let ephemeralPoints = '';

    // localStorage keys
    const ACTIVE_GAME_KEY = 'activeGameState';
    const DARK_MODE_KEY = 'darkModeEnabled';

    /********************************************************
     * Dark Mode
     ********************************************************/
    function toggleDarkMode(event) {
      event.stopPropagation();
      const htmlElement = document.documentElement;
      const isDarkMode = htmlElement.classList.toggle('dark');
      localStorage.setItem(DARK_MODE_KEY, isDarkMode);
      updateDarkModeButton(isDarkMode);
      updateMetaThemeColor(isDarkMode);
    }

    function updateDarkModeButton(isDarkMode) {
      const darkModeIcon = document.getElementById('darkModeIcon');
      const darkModeLabel = document.getElementById('darkModeLabel');
      if (darkModeIcon && darkModeLabel) {
        darkModeIcon.innerHTML = isDarkMode ? Icons.Sun : Icons.Moon;
        darkModeLabel.textContent = isDarkMode ? 'Light Mode' : 'Dark Mode';
      }
    }

    function initializeDarkMode() {
      const isDarkMode = JSON.parse(localStorage.getItem(DARK_MODE_KEY));
      if (isDarkMode) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
      updateDarkModeButton(isDarkMode);
      updateMetaThemeColor(isDarkMode);
    }

    function updateMetaThemeColor(isDarkMode) {
      const metaThemeColor = document.querySelector('meta[name="theme-color"]');
      if (metaThemeColor) {
        metaThemeColor.setAttribute('content', isDarkMode ? '#1a202c' : '#ffffff');
      }
    }

    /********************************************************
     * LocalStorage & Utility
     ********************************************************/
    const getLocalStorage = (key) => JSON.parse(localStorage.getItem(key)) || [];
    const setLocalStorage = (key, value) => localStorage.setItem(key, JSON.stringify(value));

    function showSaveIndicator() {
      const indicator = document.getElementById('saveIndicator');
      if (indicator) {
        indicator.classList.remove('hidden');
        indicator.classList.add('show');
        setTimeout(() => {
          indicator.classList.remove('show');
          indicator.classList.add('hidden');
        }, 1000);
      }
    }

    function loadCurrentGameState() {
      const savedState = localStorage.getItem(ACTIVE_GAME_KEY);
      if (savedState) {
        try {
          const parsedState = JSON.parse(savedState);
          state = { ...state, ...parsedState };
          renderApp();
        } catch (error) {
          console.error('Failed to parse saved game state:', error);
          localStorage.removeItem(ACTIVE_GAME_KEY); 
        }
      }
    }

    function saveCurrentGameState() {
      if (!state.gameOver) {
        localStorage.setItem(ACTIVE_GAME_KEY, JSON.stringify(state));
        showSaveIndicator();
      } else {
        localStorage.removeItem(ACTIVE_GAME_KEY);
      }
    }

    function deleteGame(key, index, confirmText) {
      const list = getLocalStorage(key);
      if (!confirm(`Are you sure you want to delete this ${confirmText}?`)) return;
      list.splice(index, 1);
      setLocalStorage(key, list);
      renderSavedGames();
      renderFreezerGames();
    }

    /********************************************************
     * Slide-out Menu & Modal Behavior
     ********************************************************/
    function toggleMenu(event) {
      event.stopPropagation();
      const menu = document.getElementById("menu");
      menu.classList.toggle("show");
    }
    function closeMenu() {
      const menu = document.getElementById("menu");
      menu.classList.remove("show");
    }
    document.addEventListener("click", function (event) {
      const menu = document.getElementById("menu");
      const hamburgerMenu = document.querySelector(".hamburger-menu");
      if (
        !menu.contains(event.target) &&
        !hamburgerMenu.contains(event.target) &&
        menu.classList.contains("show")
      ) {
        closeMenu();
      }
    });

    function openSavedGamesModal() {
      renderSavedGames();
      renderFreezerGames();
      document.getElementById('savedGamesModal').classList.remove('hidden');
      document.getElementById('savedGamesModal').focus();
    }
    function closeSavedGamesModal() {
      document.getElementById('savedGamesModal').classList.add('hidden');
    }
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeSavedGamesModal();
      }
    });

    /********************************************************
     * State & Render
     ********************************************************/
    function updateState(updates) {
      state = { ...state, ...updates };
      renderApp();
    }

    /********************************************************
     * Event Handlers (bidding, etc.)
     ********************************************************/
    function handleTeamClick(team) {
      if (state.gameOver) return;
      if (state.biddingTeam === team) {
        state.savedScoreInputStates[team] = {
          bidAmount: state.bidAmount,
          customBidValue: state.customBidValue,
          showCustomBid: state.showCustomBid,
          enterBidderPoints: state.enterBidderPoints,
          error: state.error
        };
        updateState({
          biddingTeam: '',
          bidAmount: '',
          showCustomBid: false,
          customBidValue: '',
          enterBidderPoints: false,
          error: ''
        });
      } else {
        const otherTeam = team === 'us' ? 'Dem' : 'us';
        state.savedScoreInputStates[otherTeam] = null;

        let newState = {
          biddingTeam: team,
          bidAmount: '',
          showCustomBid: false,
          customBidValue: '',
          enterBidderPoints: false,
          error: ''
        };
        const savedState = state.savedScoreInputStates[team];
        if (savedState) {
          newState = { ...newState, ...savedState };
        }
        updateState(newState);
      }
      ephemeralCustomBid = '';
      ephemeralPoints = '';
    }

    function handleBidSelect(value) {
      if (value === 'other') {
        ephemeralCustomBid = '';
        updateState({ showCustomBid: true, bidAmount: '', customBidValue: '' });
      } else {
        ephemeralCustomBid = '';
        updateState({ showCustomBid: false, bidAmount: value.toString(), customBidValue: '' });
      }
      if (value !== 'other') {
        updateState({ lastBidAmount: value.toString(), lastBidTeam: state.biddingTeam });
      } else {
        updateState({ lastBidAmount: null, lastBidTeam: null });
      }
    }

    function handleCustomBidChange(e) {
      ephemeralCustomBid = e.target.value;
      const validationError = validateBid(ephemeralCustomBid);
      if (!validationError) {
        updateState({
          customBidValue: ephemeralCustomBid,
          bidAmount: ephemeralCustomBid,
          lastBidAmount: ephemeralCustomBid,
          lastBidTeam: state.biddingTeam
        });
      } else {
        updateState({
          customBidValue: ephemeralCustomBid,
          bidAmount: '',
          lastBidAmount: null,
          lastBidTeam: null
        });
      }
    }

    function handleBiddingPointsToggle(isBidder) {
      ephemeralPoints = '';
      updateState({ enterBidderPoints: isBidder });
    }

    function handleFormSubmit(e) {
      e.preventDefault();
      const { biddingTeam, bidAmount, rounds, enterBidderPoints } = state;
      const pointsInput = document.getElementById('pointsInput');
      if (!pointsInput) {
        updateState({ error: 'Points input field not found.' });
        return;
      }
      const points = pointsInput.value;
      if (!biddingTeam || !bidAmount) {
        updateState({ error: 'Please select both team and bid.' });
        return;
      }
      const bidError = validateBid(bidAmount);
      const pointsError = validatePoints(points);
      if (bidError || pointsError) {
        updateState({ error: bidError || pointsError });
        return;
      }

      const bid = Number(bidAmount);
      const pointsValue = Number(points);

      const bidderPoints = enterBidderPoints
        ? pointsValue
        : pointsValue === 360
          ? 360
          : 180 - pointsValue;
      const nonBidderPoints = pointsValue === 360 ? 0 : 180 - bidderPoints;

      const usPoints = biddingTeam === 'us'
        ? (bidderPoints < bid ? -bid : bidderPoints)
        : nonBidderPoints;
      const DemPoints = biddingTeam === 'Dem'
        ? (bidderPoints < bid ? -bid : bidderPoints)
        : nonBidderPoints;

      const prevTotals = rounds.length ? rounds[rounds.length - 1].runningTotals : { us: 0, Dem: 0 };
      const newRunningTotals = {
        us: prevTotals.us + usPoints,
        Dem: prevTotals.Dem + DemPoints
      };

      const newRounds = [...rounds,
        {
          biddingTeam,
          bidAmount: bid,
          usPoints,
          DemPoints,
          runningTotals: newRunningTotals,
        }
      ];

      // Evaluate possible game-over conditions
      const wonOnBid = biddingTeam === 'us'
        ? usPoints >= bid && usPoints > 0
        : DemPoints >= bid && DemPoints > 0;
      const setOtherTeam = biddingTeam === 'us' ? DemPoints < 0 : usPoints < 0;
      const pointSpread = Math.abs(newRunningTotals.us - newRunningTotals.Dem);
      const spreadWinner = newRunningTotals.us > newRunningTotals.Dem ? 'us' : 'Dem';
      const spreadCondition = pointSpread >= 1000;

      const otherTeam = biddingTeam === 'us' ? 'Dem' : 'us';
      const otherTeamTotal = newRunningTotals[otherTeam];
      const biddingTeamFailedBid = biddingTeam === 'us' ? usPoints < 0 : DemPoints < 0;

      let gameEnded = false;
      let finalWinner = null;
      let endReason = '';

      if (
        ((biddingTeam === 'us' && newRunningTotals.us >= 500) ||
         (biddingTeam === 'Dem' && newRunningTotals.Dem >= 500)) &&
        (wonOnBid || setOtherTeam)
      ) {
        gameEnded = true;
        finalWinner = biddingTeam;
        endReason = 'reached 500 points';
      } 
      else if (biddingTeamFailedBid && otherTeamTotal >= 500) {
        gameEnded = true;
        finalWinner = otherTeam;
        endReason = `${otherTeam} reached 500 points after ${
          biddingTeam === 'us' ? 'our team' : 'Dem team'
        } failed their bid`;
      }
      else if (spreadCondition) {
        gameEnded = true;
        finalWinner = spreadWinner;
        endReason = 'a 1000-point spread';
      }

      ephemeralCustomBid = '';
      ephemeralPoints = '';

      if (gameEnded) {
        alert(`Game Over! ${finalWinner === 'us' ? 'Our Team' : 'Dem Team'} wins by ${endReason}.`);
      }

      updateState({
        rounds: newRounds,
        gameOver: gameEnded,
        winner: finalWinner,
        biddingTeam: '',
        bidAmount: '',
        showCustomBid: false,
        customBidValue: '',
        enterBidderPoints: false,
        error: ''
      });

      saveCurrentGameState();
    }

    function handleUndo() {
      if (!state.rounds.length) return;
      const newRounds = state.rounds.slice(0, -1);
      let newLastBidAmount = null;
      let newLastBidTeam = null;

      if (newRounds.length > 0) {
        const lastRound = newRounds[newRounds.length - 1];
        newLastBidAmount = lastRound.bidAmount.toString();
        newLastBidTeam = lastRound.biddingTeam;
      }

      updateState({
        rounds: newRounds,
        gameOver: false,
        winner: null,
        lastBidAmount: newLastBidAmount,
        lastBidTeam: newLastBidTeam
      });

      saveCurrentGameState();
    }

    function handleNewGame() {
      if (state.rounds.length > 0) {
        if (!confirm("Do you want to start a new game?")) return;
        if (confirm("Do you want to save the previous game result before starting a new game?")) {
          const player1 = prompt("Enter the names for Us:");
          if (!player1) {
            alert("Player 1 name is required to save the game.");
            return;
          }
          const player2 = prompt("Enter the names for Dem:");
          if (!player2) {
            alert("Player 2 name is required to save the game.");
            return;
          }
          const finalScore = state.rounds.length
            ? state.rounds[state.rounds.length - 1].runningTotals
            : { us: 0, Dem: 0 };
          const savedGames = getLocalStorage('savedGames');
          savedGames.push({
            player1: player1.trim(),
            player2: player2.trim(),
            rounds: state.rounds,
            finalScore,
            timestamp: new Date().toISOString()
          });
          setLocalStorage('savedGames', savedGames);
          alert("Game saved successfully.");
        }
      }
      localStorage.removeItem(ACTIVE_GAME_KEY);
      ephemeralCustomBid = '';
      ephemeralPoints = '';
      updateState({ ...DEFAULT_STATE });
    }

    function handleManualSaveGame() {
      if (!state.rounds.length) {
        alert("No game in progress to save.");
        return;
      }
      const player1 = prompt("Enter the name for Us:");
      if (!player1) {
        alert("Player 1 name is required to save the game.");
        return;
      }
      const player2 = prompt("Enter the name for Dem:");
      if (!player2) {
        alert("Player 2 name is required to save the game.");
        return;
      }
      const finalScore = state.rounds.length
        ? state.rounds[state.rounds.length - 1].runningTotals
        : { us: 0, Dem: 0 };
      const savedGames = getLocalStorage('savedGames');
      savedGames.push({
        player1: player1.trim(),
        player2: player2.trim(),
        rounds: state.rounds,
        finalScore,
        timestamp: new Date().toISOString()
      });
      setLocalStorage('savedGames', savedGames);
      alert("Game saved successfully.");
      localStorage.removeItem(ACTIVE_GAME_KEY);

      ephemeralCustomBid = '';
      ephemeralPoints = '';
      updateState({ ...DEFAULT_STATE });
    }

    function handleFreezerGame() {
      if (!state.rounds.length) {
        alert("No game in progress to freeze.");
        return;
      }
      let gameName = prompt("Enter a name for this freezer game:");
      if (gameName === null) return;
      gameName = gameName.trim();
      if (!gameName) {
        alert("Game name cannot be empty.");
        return;
      }
      const freezerGames = getLocalStorage('freezerGames');
      if (freezerGames.some(g => g.name.toLowerCase() === gameName.toLowerCase())) {
        alert("A freezer game with this name already exists. Please choose a different name.");
        return;
      }
      const lastRound = state.rounds[state.rounds.length - 1];
      const totals = state.rounds.reduce((acc, round) => ({
        us: acc.us + round.usPoints,
        Dem: acc.Dem + round.DemPoints
      }), { us: 0, Dem: 0 });
      freezerGames.push({
        name: gameName,
        finalScore: { us: totals.us, Dem: totals.Dem },
        lastBid: lastRound.bidAmount,
        rounds: state.rounds,
        timestamp: new Date().toISOString()
      });
      setLocalStorage('freezerGames', freezerGames);
      alert("Current game with complete history has been frozen successfully.");
      localStorage.removeItem(ACTIVE_GAME_KEY);

      ephemeralCustomBid = '';
      ephemeralPoints = '';
      updateState({ ...DEFAULT_STATE });
    }

    function loadFreezerGame(index) {
      const freezerGames = getLocalStorage('freezerGames');
      const freezerGame = freezerGames[index];
      if (!freezerGame) {
        alert("Selected freezer game does not exist.");
        return;
      }
      if (!confirm(`Load the freezer game "${freezerGame.name}"? This will overwrite the current game.`)) return;
      updateState({
        rounds: freezerGame.rounds,
        gameOver: false,
        winner: null,
        biddingTeam: '',
        bidAmount: '',
        showCustomBid: false,
        customBidValue: '',
        enterBidderPoints: false,
        error: '',
        lastBidAmount: null,
        lastBidTeam: null
      });
      freezerGames.splice(index, 1);
      setLocalStorage('freezerGames', freezerGames);
      alert(`Freezer game "${freezerGame.name}" loaded successfully.`);
      closeSavedGamesModal();
      saveCurrentGameState();
    }

    function renderSavedGames() {
      const savedGames = getLocalStorage('savedGames');
      const savedGamesListEl = document.getElementById('savedGamesList');
      if (!savedGames.length) {
        savedGamesListEl.innerHTML = `<p class="text-gray-600 dark:text-gray-300">No completed games available.</p>`;
        return;
      }
      savedGamesListEl.innerHTML = savedGames
        .map((game, index) => `
          <div class="border p-4 rounded-lg shadow-sm bg-gray-50 dark:bg-gray-700">
            <div class="flex justify-between items-center">
              <div>
                <p class="font-semibold text-gray-800 dark:text-gray-100">Players:</p>
                <p>${game.player1} vs ${game.player2}</p>
              </div>
              <button 
                onclick="deleteSavedGame(${index})" 
                class="text-red-600 hover:text-red-800 focus:outline-none focus:ring-2 focus:ring-red-500
                       dark:text-red-400 dark:hover:text-red-600" 
                aria-label="Delete Saved Game"
              >
                ${Icons.Trash}
              </button>
            </div>
            <div class="mt-2">
              <p class="font-semibold text-gray-800 dark:text-gray-100">Final Score:</p>
              <p>Us: ${game.finalScore.us} | Dem: ${game.finalScore.Dem}</p>
            </div>
            <div class="mt-2">
              <p class="font-semibold text-gray-800 dark:text-gray-100">Date:</p>
              <p>${new Date(game.timestamp).toLocaleString()}</p>
            </div>
          </div>
        `)
        .join('');
    }

    function renderFreezerGames() {
      const freezerGames = getLocalStorage('freezerGames');
      const freezerGamesListEl = document.getElementById('freezerGamesList');
      if (!freezerGames.length) {
        freezerGamesListEl.innerHTML = `<p class="text-gray-600 dark:text-gray-300">No freezer games available.</p>`;
        return;
      }
      freezerGamesListEl.innerHTML = freezerGames
        .map((game, index) => `
          <div class="border p-4 rounded-lg shadow-sm bg-gray-50 dark:bg-gray-700">
            <div class="flex justify-between items-center">
              <div>
                <p class="font-semibold text-gray-800 dark:text-gray-100">Name:</p>
                <p>${game.name}</p>
              </div>
              <div class="flex space-x-2">
                <button 
                  onclick="loadFreezerGame(${index})" 
                  class="text-blue-600 hover:text-blue-800 flex items-center focus:outline-none focus:ring-2 focus:ring-blue-500 
                         dark:text-blue-400 dark:hover:text-blue-600" 
                  aria-label="Load Freezer Game"
                >
                  ${Icons.Load}Load
                </button>
                <button 
                  onclick="deleteFreezerGame(${index})" 
                  class="text-red-600 hover:text-red-800 focus:outline-none focus:ring-2 focus:ring-red-500 
                         dark:text-red-400 dark:hover:text-red-600" 
                  aria-label="Delete Freezer Game"
                >
                  ${Icons.Trash}
                </button>
              </div>
            </div>
            <div class="mt-2">
              <p class="font-semibold text-gray-800 dark:text-gray-100">Final Score:</p>
              <p>Us: ${game.finalScore.us} | Dem: ${game.finalScore.Dem}</p>
            </div>
            <div class="mt-2">
              <p class="font-semibold text-gray-800 dark:text-gray-100">Last Bid:</p>
              <p>${game.lastBid}</p>
            </div>
            <div class="mt-2">
              <p class="font-semibold text-gray-800 dark:text-gray-100">Date Frozen:</p>
              <p>${new Date(game.timestamp).toLocaleString()}</p>
            </div>
          </div>
        `)
        .join('');
    }

    function deleteSavedGame(index) {
      deleteGame('savedGames', index, 'saved game');
    }
    function deleteFreezerGame(index) {
      deleteGame('freezerGames', index, 'freezer game');
    }

    /********************************************************
     * Render Functions
     ********************************************************/
    /**
     * Renders the two team boxes, which are narrower now (w-32).
     */
    function renderTeamCard(team, total, colorClass) {
      const isSelected = (state.biddingTeam === team);
      const backgroundClass = isSelected
        ? `bg-${colorClass}-900 text-white`
        : `bg-${colorClass}-500 text-white`;
      return `
        <div
          class="${backgroundClass} cursor-pointer hover:${backgroundClass} transition-colors
                 rounded-md shadow-md flex items-center justify-center w-32 h-24"
          onclick="handleTeamClick('${team}')"
          tabindex="0"
          role="button"
          aria-pressed="${isSelected}"
          aria-label="Select ${team === 'us' ? 'Our Team' : 'Dem Team'}"
        >
          <div class="flex flex-col items-center">
            <h2 class="text-xl font-semibold capitalize">
              ${team === 'us' ? 'Us' : 'Dem'}
            </h2>
            <p class="text-2xl font-bold">${total}</p>
          </div>
        </div>
      `;
    }

    /**
     * Renders the Round card, which is wider (w-48).
     */
    function renderRoundCard(currentRound, bidDisplay) {
      return `
        <div class="bg-white border border-gray-200 rounded-md shadow flex flex-col items-center justify-center p-4
                    flex-1 min-w-0 w-48 h-24 dark:bg-gray-800 dark:border-gray-700">
          <div class="text-center space-y-1">
            <h2 class="text-xl font-bold text-gray-700 dark:text-gray-100">Round</h2>
            <p class="text-2xl font-extrabold text-gray-900 dark:text-gray-100">${currentRound}</p>
            ${bidDisplay}
          </div>
        </div>
      `;
    }

    function renderErrorAlert(errorMsg) {
      return `
        <div role="alert" class="flex items-center border border-red-400 rounded-md p-4 bg-red-50 text-red-700 space-x-3
                                dark:bg-red-700 dark:border-red-600 dark:text-red-100">
          <div class="flex-shrink-0">${Icons.AlertCircle}</div>
          <div class="flex-1">${errorMsg}</div>
        </div>
      `;
    }

    function renderPointsInput() {
      const { biddingTeam, enterBidderPoints } = state;
      const labelText =
        biddingTeam === 'us'
          ? enterBidderPoints
            ? 'Our Points (Bidding Team)'
            : 'Dem Points (Non-Bidding Team)'
          : enterBidderPoints
            ? 'Dem Points (Bidding Team)'
            : 'Our Points (Non-Bidding Team)';

      let biddingTeamColor = 'blue';
      let nonBiddingTeamColor = 'red';
      if (biddingTeam === 'Dem') {
        biddingTeamColor = 'red';
        nonBiddingTeamColor = 'blue';
      }

      const biddingTeamClasses = enterBidderPoints
        ? `bg-${biddingTeamColor}-600 text-white shadow hover:bg-${biddingTeamColor}-700 dark:bg-${biddingTeamColor}-700 dark:hover:bg-${biddingTeamColor}-800`
        : `bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 dark:bg-gray-600 dark:border-gray-500 dark:text-gray-200 dark:hover:bg-gray-500`;

      const nonBiddingTeamClasses = !enterBidderPoints
        ? `bg-${nonBiddingTeamColor}-600 text-white shadow hover:bg-${nonBiddingTeamColor}-700 dark:bg-${nonBiddingTeamColor}-700 dark:hover:bg-${nonBiddingTeamColor}-800`
        : `bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 dark:bg-gray-600 dark:border-gray-500 dark:text-gray-200 dark:hover:bg-gray-500`;

      return `
        <div class="space-y-6">
          <div>
            <label for="pointsToggle" class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-200">Enter Points For</label>
            <div class="flex gap-4">
              <!-- Bidding Team Button -->
              <button
                type="button"
                class="flex-1 rounded-full px-4 py-2 text-sm font-medium ${biddingTeamClasses} transition
                       focus:outline-none focus:ring-2 focus:ring-${biddingTeamColor}-500 focus:ring-opacity-50"
                onclick="handleBiddingPointsToggle(true)"
                aria-pressed="${enterBidderPoints}"
              >
                Bidding Team
              </button>
              <!-- Non-Bidding Team Button -->
              <button
                type="button"
                class="flex-1 rounded-full px-4 py-2 text-sm font-medium ${nonBiddingTeamClasses} transition
                       focus:outline-none focus:ring-2 focus:ring-${nonBiddingTeamColor}-500 focus:ring-opacity-50"
                onclick="handleBiddingPointsToggle(false)"
                aria-pressed="${!enterBidderPoints}"
              >
                Non-Bidding Team
              </button>
            </div>
          </div>

          <div>
            <label for="pointsInput" class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-200">${labelText}</label>
            <div class="flex flex-col sm:flex-row sm:items-center sm:gap-4">
              <input
                id="pointsInput"
                type="number"
                inputmode="numeric"
                pattern="[0-9]*"
                min="0"
                max="360"
                placeholder="Enter points"
                class="w-full sm:w-1/2 border border-gray-300 rounded-lg px-4 py-2
                       focus:outline-none focus:ring-2 focus:ring-blue-500 transition
                       dark:bg-gray-600 dark:border-gray-500 dark:text-gray-100 dark:focus:ring-blue-400"
                aria-label="Enter Points"
              />
              <button
                type="submit"
                class="mt-4 sm:mt-0 bg-blue-600 text-white px-6 py-2 rounded-lg shadow
                       hover:bg-blue-700 focus:outline-none focus:ring-2
                       focus:ring-blue-500 transition dark:bg-blue-500 dark:hover:bg-blue-600 dark:focus:ring-blue-400"
              >
                Submit
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderScoreInputCard() {
      const { biddingTeam, bidAmount, customBidValue, showCustomBid, rounds, gameOver } = state;
      if (gameOver || !biddingTeam) return '';
      const showPointsSection = bidAmount || showCustomBid;

      return `
        <div class="bg-white border border-gray-200 rounded-lg shadow-lg dark:bg-gray-800 dark:border-gray-700">
          <div class="border-b border-gray-200 p-5 flex justify-between items-center dark:border-gray-700">
            <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100">
              Score Input for ${biddingTeam === 'us' ? 'Our Team' : 'Dem Team'}
            </h2>
            <button
              class="flex items-center border border-gray-300 rounded px-3 py-2 text-sm
                     text-gray-700 hover:bg-gray-200 transition disabled:opacity-50
                     focus:outline-none focus:ring-2 focus:ring-blue-500
                     dark:border-gray-600 dark:text-gray-200 dark:hover:bg-gray-700 dark:focus:ring-blue-400"
              onclick="handleUndo(event)" ${!rounds.length ? 'disabled' : ''}
              title="Undo Last Round"
              aria-label="Undo Last Round"
            >
              ${Icons.Undo}Undo
            </button>
          </div>
          <div class="p-6 score-input-container ${state.biddingTeam ? 'show' : ''}">
            <form onsubmit="handleFormSubmit(event)" class="space-y-6">
              <div>
                <label for="bidAmount" class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-200">Bid Amount</label>
                <div class="flex flex-wrap gap-3">
                  ${presetBids.map((bid) => {
                    const isSelected = (bid === 'other')
                      ? showCustomBid
                      : (bidAmount === String(bid));
                    const variant = isSelected
                      ? 'bg-blue-600 text-white shadow hover:bg-blue-700 dark:bg-blue-600 dark:hover:bg-blue-700'
                      : 'bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 dark:bg-gray-600 dark:border-gray-500 dark:text-gray-200 dark:hover:bg-gray-500';
                    const roundedClass = (bid === 'other') ? 'rounded-full' : 'rounded-lg';
                    return `
                      <button
                        type="button"
                        class="px-4 py-2 text-sm font-medium ${variant} ${roundedClass} transition
                               focus:outline-none focus:ring-2 focus:ring-blue-500 dark:ring-blue-400"
                        onclick="handleBidSelect('${bid}')"
                        aria-pressed="${isSelected}"
                        aria-label="Select Bid ${bid === 'other' ? 'Other' : bid}"
                      >
                        ${bid === 'other' ? 'Other' : bid}
                      </button>
                    `;
                  }).join('')}
                </div>
                ${
                  showCustomBid
                    ? `
                      <div class="mt-4 flex flex-col sm:flex-row sm:items-center sm:gap-4">
                        <input
                          type="number"
                          inputmode="numeric"
                          pattern="[0-9]*"
                          step="5"
                          value="${customBidValue}"
                          onchange="handleCustomBidChange(event)"
                          placeholder="Enter custom bid"
                          class="w-full sm:w-1/2 border border-gray-300 rounded-lg px-4 py-2
                                 focus:outline-none focus:ring-2 focus:ring-blue-500 transition
                                 dark:bg-gray-600 dark:border-gray-500 dark:text-gray-100 dark:focus:ring-blue-400"
                          aria-label="Custom Bid Amount"
                        />
                        <span class="text-sm text-gray-500 dark:text-gray-300">Must be divisible by 5 (≤180 or 360)</span>
                      </div>
                    `
                    : ''
                }
              </div>
              ${ showPointsSection ? renderPointsInput() : '' }
            </form>
          </div>
        </div>
      `;
    }

    function renderHistoryCard() {
      const { rounds } = state;
      return `
        <div class="bg-white border border-gray-200 rounded-lg shadow-lg 
                    dark:bg-gray-800 dark:border-gray-700">
          <div class="border-b border-gray-200 p-4 dark:border-gray-700">
            <h2 class="text-lg font-bold text-gray-800 dark:text-gray-100">History</h2>
            <div class="grid grid-cols-3 gap-2 pt-3 font-medium text-gray-600 dark:text-gray-300 text-sm sm:text-base">
              <div class="text-left">Us</div>
              <div class="text-center">Bid</div>
              <div class="text-right">Dem</div>
            </div>
          </div>
          <div class="p-4">
            <div class="space-y-2">
              ${
                rounds.map((round, index) => {
                  const arrow = round.biddingTeam === 'us'
                    ? `<span class="text-gray-800 dark:text-gray-100">←</span><span class="ml-1">${round.bidAmount}</span>`
                    : `<span class="mr-1">${round.bidAmount}</span><span class="text-gray-800 dark:text-gray-100">→</span>`;
                  return `
                    <div key="${index}" class="grid grid-cols-3 gap-2 p-2 bg-gray-50 rounded-lg animate-fade-in dark:bg-gray-700">
                      <div class="text-left text-gray-800 dark:text-gray-100 font-semibold">${round.runningTotals.us}</div>
                      <div class="flex items-center justify-center">${arrow}</div>
                      <div class="text-right text-gray-800 dark:text-gray-100 font-semibold">${round.runningTotals.Dem}</div>
                    </div>
                  `;
                }).join('')
              }
            </div>
          </div>
        </div>
      `;
    }

    function renderGameOverOverlay() {
      if (!state.gameOver) return '';
      const { winner } = state;
      return `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4" role="alertdialog" aria-labelledby="gameOverTitle" aria-modal="true">
          <div class="bg-white w-full max-w-md rounded-lg shadow-lg dark:bg-gray-800">
            <div class="p-6 text-center">
              <h2 id="gameOverTitle" class="text-3xl font-bold mb-4 animate-fade-in text-gray-800 dark:text-gray-100">Game Over!</h2>
              <p class="text-xl mb-6 animate-fade-in text-gray-700 dark:text-gray-300">${winner === 'us' ? 'Our Team' : 'Dem Team'} Wins!</p>
              <button
                onclick="handleNewGame()"
                class="bg-blue-600 text-white px-6 py-3 rounded-lg shadow hover:bg-blue-700
                       focus:outline-none focus:ring-2 focus:ring-blue-500 transition dark:bg-blue-500 dark:hover:bg-blue-600 dark:focus:ring-blue-400"
              >
                New Game
              </button>
            </div>
          </div>
        </div>
      `;
    }

    /********************************************************
     * Main Render
     ********************************************************/
    function renderApp() {
      const { error, rounds, lastBidAmount, lastBidTeam } = state;
      const totals = rounds.reduce(
        (acc, round) => ({
          us: acc.us + round.usPoints,
          Dem: acc.Dem + round.DemPoints
        }),
        { us: 0, Dem: 0 }
      );
      const currentRound = rounds.length + 1;

      let bidDisplay = '';
      if (lastBidAmount && lastBidTeam) {
        const arrow = (lastBidTeam === 'us') ? '←' : '→';
        bidDisplay = `
          <div class="mt-2 flex items-center justify-center space-x-1 text-gray-700 dark:text-gray-300">
            <span class="font-medium">Bid:</span>
            <span>${lastBidAmount}</span>
            <span>${arrow}</span>
          </div>
        `;
      }

      document.getElementById('app').innerHTML = `
        <div class="text-center space-y-2">
          <div class="flex flex-col items-center">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-800 dark:text-gray-100">Rook!</h1>
          </div>
          <p class="text-md sm:text-lg text-gray-600 dark:text-gray-300">Tap a team to start a bid!</p>
        </div>

        <!-- Teams and Round -->
        <div class="flex flex-row space-x-4 flex-wrap justify-center">
          ${renderTeamCard('us', totals.us, 'blue')}
          ${renderRoundCard(currentRound, bidDisplay)}
          ${renderTeamCard('Dem', totals.Dem, 'red')}
        </div>

        <!-- Error Alert (if any) -->
        ${error ? `<div>${renderErrorAlert(error)}</div>` : ''}

        <!-- Score Input Card -->
        ${renderScoreInputCard()}

        <!-- History Card -->
        ${renderHistoryCard()}

        <!-- Game Over Overlay -->
        ${renderGameOverOverlay()}
      `;
    }

    /********************************************************
     * Initialization
     ********************************************************/
    document.addEventListener('DOMContentLoaded', () => {
      // Close modal button
      const closeBtn = document.getElementById('closeSavedGamesModalBtn');
      if (closeBtn) {
        closeBtn.addEventListener('click', closeSavedGamesModal);
      }

      // Load from localStorage if any
      loadCurrentGameState();
      // init dark mode
      initializeDarkMode();

      // If you want a Service Worker, do it over http/https
      /*
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('/service-worker.js').then(
            function(registration) {
              console.log('ServiceWorker registration successful with scope: ', registration.scope);
            }, 
            function(err) {
              console.log('ServiceWorker registration failed: ', err);
            }
          );
        });
      }
      */

      // Initial render
      renderApp();
    });
  </script>
</body>
</html>
